<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jhy97.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="前言本文分享Mybatis的Configuration初始化流程，配置参考。重点分析XML资源文件解析和功能实现。   一、加载配置Mybatis加载配置文件分为两个步骤：  将文件转换为资源 123String resource &#x3D; &quot;mybatis-config.xml&quot;;&#x2F;&#x2F; 使用类加载器加载配置文件获取InputStreamInputStream inputStream">
<meta property="og:type" content="article">
<meta property="og:title" content="Mybatis源码解析 Configuration初始化">
<meta property="og:url" content="http://jhy97.top/2021/06/16/mybatis/Mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%20Configuration%E5%88%9D%E5%A7%8B%E5%8C%96/index.html">
<meta property="og:site_name" content="天不错啊">
<meta property="og:description" content="前言本文分享Mybatis的Configuration初始化流程，配置参考。重点分析XML资源文件解析和功能实现。   一、加载配置Mybatis加载配置文件分为两个步骤：  将文件转换为资源 123String resource &#x3D; &quot;mybatis-config.xml&quot;;&#x2F;&#x2F; 使用类加载器加载配置文件获取InputStreamInputStream inputStream">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/__puml/a57785b938ac31bbebf37b3c520d7749.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYWJzdHJhY3QgY2xhc3MgQmFzZUJ1aWxkZXJcbmNsYXNzIFhNTENvbmZpZ0J1aWxkZXIgZXh0ZW5kcyBCYXNlQnVpbGRlclxuXG5hYnN0cmFjdCBjbGFzcyBCYXNlQnVpbGRlcntcblx0IyBDb25maWd1cmF0aW9uIGNvbmZpZ3VyYXRpb25cblx0IyBUeXBlQWxpYXNSZWdpc3RyeSB0eXBlQWxpYXNSZWdpc3RyeVxuXHQjIFR5cGVIYW5kbGVyUmVnaXN0cnkgdHlwZUhhbmRsZXJSZWdpc3RyeVxufVxubm90ZSBsZWZ0IG9mIEJhc2VCdWlsZGVyOjpjb25maWd1cmF0aW9uXG4gIOmcgOimgeWwhlhNTOaWh-S7tuS4reeahOmFjee9ruaYoOWwhOWIsOivpeexu-S4rVxuZW5kIG5vdGVcbm5vdGUgbGVmdCBvZiBCYXNlQnVpbGRlcjo6dHlwZUFsaWFzUmVnaXN0cnlcbiAg5Yir5ZCN5rOo5YaM5Zmo77yM55So5LqO5Zyo6YWN572u5Lit6L-b6KGM57yp5YaZ44CCXG5lbmQgbm90ZVxubm90ZSBsZWZ0IG9mIEJhc2VCdWlsZGVyOjp0eXBlSGFuZGxlclJlZ2lzdHJ5XG4gIOexu-Wei-WkhOeQhuWZqO-8jOeUqOS6juWwhkphdmHnsbvlnosgPC0tPiBKREJD57G75Z6L77yM55u45LqS6L2s5o2i44CCXG5lbmQgbm90ZVxuXG5jbGFzcyBYTUxDb25maWdCdWlsZGVye1xuXHQrIENvbmZpZ3VyYXRpb24gcGFyc2UoKVxuXHQtIHZvaWQgcGFyc2VDb25maWd1cmF0aW9uKFhOb2RlIHJvb3QpXG59XG5ub3RlIGxlZnQgb2YgWE1MQ29uZmlnQnVpbGRlcjo6cGFyc2VcbiAg6Kej5p6Q6YWN572u77yM6L-U5ZueQ29uZmlndXJhdGlvblxuZW5kIG5vdGVcbm5vdGUgbGVmdCBvZiBYTUxDb25maWdCdWlsZGVyOjpwYXJzZUNvbmZpZ3VyYXRpb25cbiAg6Kej5p6Q6YWN572u77yM6YWN572u5pig5bCE5YiwQ29uZmlndXJhdGlvblxuZW5kIG5vdGVcbkBlbmR1bWwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sL2E1Nzc4NWI5MzhhYzMxYmJlYmYzN2IzYzUyMGQ3NzQ5LnN2ZyIsImlkIjoiQ2x2NDkiLCJtYXJnaW4iOnsidG9wIjp0cnVlLCJib3R0b20iOnRydWV9LCJjYXJkIjoiZGlhZ3JhbSJ9">
<meta property="og:image" content="https://cdn.nlark.com/yuque/__puml/9ddf552a8aec9d85f16a7cbbdc9cdb64.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYWJzdHJhY3QgY2xhc3MgQmFzZUJ1aWxkZXJcbmNsYXNzIFhNTE1hcHBlckJ1aWxkZXIgZXh0ZW5kcyBCYXNlQnVpbGRlciBcbmNsYXNzIE1hcHBlckJ1aWxkZXJBc3Npc3RhbnRcbm5vdGUgbGVmdDogTWFwcGVy5p6E5bu65Yqp5omL77yM55So5LqO5LiA5Lqb5aSE55CGTWFwcGVy5qCH562-55qE5bel5L2c77yM5bCG5aSE55CG57uT5p6c6K6-572u6L-bQ29uZmlndXJhdGlvbuS4reOAglxuXG5CYXNlQnVpbGRlciA8fC0tIE1hcHBlckJ1aWxkZXJBc3Npc3RhbnRcblhNTE1hcHBlckJ1aWxkZXIgKi0tIE1hcHBlckJ1aWxkZXJBc3Npc3RhbnRcblxuYWJzdHJhY3QgY2xhc3MgQmFzZUJ1aWxkZXJ7XG5cdCMgQ29uZmlndXJhdGlvbiBjb25maWd1cmF0aW9uXG5cdCMgVHlwZUFsaWFzUmVnaXN0cnkgdHlwZUFsaWFzUmVnaXN0cnlcblx0IyBUeXBlSGFuZGxlclJlZ2lzdHJ5IHR5cGVIYW5kbGVyUmVnaXN0cnlcbn1cblxuY2xhc3MgWE1MTWFwcGVyQnVpbGRlcntcblx0KyB2b2lkIHBhcnNlKClcblx0LSB2b2lkIGNvbmZpZ3VyYXRpb25FbGVtZW50KFhOb2RlIHJvb3QpXG59XG5ub3RlIGxlZnQgb2YgQmFzZUJ1aWxkZXI6OmNvbmZpZ3VyYXRpb25cbiAg6ZyA6KaB5bCGWE1M5paH5Lu25Lit55qE6YWN572u5pig5bCE5Yiw6K-l57G75LitXG5lbmQgbm90ZVxubm90ZSBsZWZ0IG9mIEJhc2VCdWlsZGVyOjp0eXBlQWxpYXNSZWdpc3RyeVxuICDliKvlkI3ms6jlhozlmajvvIznlKjkuo7lnKjphY3nva7kuK3ov5vooYznvKnlhpnjgIJcbmVuZCBub3RlXG5ub3RlIGxlZnQgb2YgQmFzZUJ1aWxkZXI6OnR5cGVIYW5kbGVyUmVnaXN0cnlcbiAg57G75Z6L5aSE55CG5Zmo77yM55So5LqO5bCGSmF2Yeexu-WeiyA8LS0-IEpEQkPnsbvlnovvvIznm7jkupLovazmjaLjgIJcbmVuZCBub3RlXG5ub3RlIGxlZnQgb2YgWE1MTWFwcGVyQnVpbGRlcjo6cGFyc2VcbiAg6Kej5p6Q6YWN572uXG5lbmQgbm90ZVxubm90ZSBsZWZ0IG9mIFhNTE1hcHBlckJ1aWxkZXI6OmNvbmZpZ3VyYXRpb25FbGVtZW50XG4gIOino-aekOmFjee9ru-8jOmFjee9ruaYoOWwhOWIsENvbmZpZ3VyYXRpb25cbmVuZCBub3RlXG5AZW5kdW1sIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC85ZGRmNTUyYThhZWM5ZDg1ZjE2YTdjYmJkYzljZGI2NC5zdmciLCJpZCI6Im5VNm9FIiwibWFyZ2luIjp7InRvcCI6dHJ1ZSwiYm90dG9tIjp0cnVlfSwiY2FyZCI6ImRpYWdyYW0ifQ==">
<meta property="article:published_time" content="2021-06-16T08:12:00.000Z">
<meta property="article:modified_time" content="2022-12-19T02:53:10.338Z">
<meta property="article:author" content="JiHongYuan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/__puml/a57785b938ac31bbebf37b3c520d7749.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYWJzdHJhY3QgY2xhc3MgQmFzZUJ1aWxkZXJcbmNsYXNzIFhNTENvbmZpZ0J1aWxkZXIgZXh0ZW5kcyBCYXNlQnVpbGRlclxuXG5hYnN0cmFjdCBjbGFzcyBCYXNlQnVpbGRlcntcblx0IyBDb25maWd1cmF0aW9uIGNvbmZpZ3VyYXRpb25cblx0IyBUeXBlQWxpYXNSZWdpc3RyeSB0eXBlQWxpYXNSZWdpc3RyeVxuXHQjIFR5cGVIYW5kbGVyUmVnaXN0cnkgdHlwZUhhbmRsZXJSZWdpc3RyeVxufVxubm90ZSBsZWZ0IG9mIEJhc2VCdWlsZGVyOjpjb25maWd1cmF0aW9uXG4gIOmcgOimgeWwhlhNTOaWh-S7tuS4reeahOmFjee9ruaYoOWwhOWIsOivpeexu-S4rVxuZW5kIG5vdGVcbm5vdGUgbGVmdCBvZiBCYXNlQnVpbGRlcjo6dHlwZUFsaWFzUmVnaXN0cnlcbiAg5Yir5ZCN5rOo5YaM5Zmo77yM55So5LqO5Zyo6YWN572u5Lit6L-b6KGM57yp5YaZ44CCXG5lbmQgbm90ZVxubm90ZSBsZWZ0IG9mIEJhc2VCdWlsZGVyOjp0eXBlSGFuZGxlclJlZ2lzdHJ5XG4gIOexu-Wei-WkhOeQhuWZqO-8jOeUqOS6juWwhkphdmHnsbvlnosgPC0tPiBKREJD57G75Z6L77yM55u45LqS6L2s5o2i44CCXG5lbmQgbm90ZVxuXG5jbGFzcyBYTUxDb25maWdCdWlsZGVye1xuXHQrIENvbmZpZ3VyYXRpb24gcGFyc2UoKVxuXHQtIHZvaWQgcGFyc2VDb25maWd1cmF0aW9uKFhOb2RlIHJvb3QpXG59XG5ub3RlIGxlZnQgb2YgWE1MQ29uZmlnQnVpbGRlcjo6cGFyc2VcbiAg6Kej5p6Q6YWN572u77yM6L-U5ZueQ29uZmlndXJhdGlvblxuZW5kIG5vdGVcbm5vdGUgbGVmdCBvZiBYTUxDb25maWdCdWlsZGVyOjpwYXJzZUNvbmZpZ3VyYXRpb25cbiAg6Kej5p6Q6YWN572u77yM6YWN572u5pig5bCE5YiwQ29uZmlndXJhdGlvblxuZW5kIG5vdGVcbkBlbmR1bWwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sL2E1Nzc4NWI5MzhhYzMxYmJlYmYzN2IzYzUyMGQ3NzQ5LnN2ZyIsImlkIjoiQ2x2NDkiLCJtYXJnaW4iOnsidG9wIjp0cnVlLCJib3R0b20iOnRydWV9LCJjYXJkIjoiZGlhZ3JhbSJ9">

<link rel="canonical" href="http://jhy97.top/2021/06/16/mybatis/Mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%20Configuration%E5%88%9D%E5%A7%8B%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Mybatis源码解析 Configuration初始化 | 天不错啊</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">天不错啊</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录生活&学习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">4</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">8</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://jhy97.top/2021/06/16/mybatis/Mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%20Configuration%E5%88%9D%E5%A7%8B%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="JiHongYuan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天不错啊">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Mybatis源码解析 Configuration初始化
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-16 16:12:00" itemprop="dateCreated datePublished" datetime="2021-06-16T16:12:00+08:00">2021-06-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-12-19 10:53:10" itemprop="dateModified" datetime="2022-12-19T10:53:10+08:00">2022-12-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">Mybatis源码解析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文分享Mybatis的Configuration初始化流程，<a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html">配置参考</a>。<br>重点分析XML资源文件解析和功能实现。  </p>
<h1 id="一、加载配置"><a href="#一、加载配置" class="headerlink" title="一、加载配置"></a>一、加载配置</h1><p>Mybatis加载配置文件分为两个步骤：</p>
<ol>
<li><p>将文件转换为资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="string">&quot;mybatis-config.xml&quot;</span>;</span><br><span class="line"><span class="comment">// 使用类加载器加载配置文件获取InputStream</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> inputStream = Resources.getResourceAsStream(resource);</span><br></pre></td></tr></table></figure>
</li>
<li><p>将资源解析为Configuration对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正式开始解析</span></span><br><span class="line"><span class="type">XMLConfigBuilder</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLConfigBuilder</span>(inputStream, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">return</span> build(parser.parse());</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="二、解析Config"><a href="#二、解析Config" class="headerlink" title="二、解析Config"></a>二、解析Config</h1><p>解析Configuration的由<strong>XMLConfigBuilder</strong>实现。</p>
<h2 id="1-XMLConfigBuilder"><a href="#1-XMLConfigBuilder" class="headerlink" title="1. XMLConfigBuilder"></a>1. XMLConfigBuilder</h2><p><img src="https://cdn.nlark.com/yuque/__puml/a57785b938ac31bbebf37b3c520d7749.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYWJzdHJhY3QgY2xhc3MgQmFzZUJ1aWxkZXJcbmNsYXNzIFhNTENvbmZpZ0J1aWxkZXIgZXh0ZW5kcyBCYXNlQnVpbGRlclxuXG5hYnN0cmFjdCBjbGFzcyBCYXNlQnVpbGRlcntcblx0IyBDb25maWd1cmF0aW9uIGNvbmZpZ3VyYXRpb25cblx0IyBUeXBlQWxpYXNSZWdpc3RyeSB0eXBlQWxpYXNSZWdpc3RyeVxuXHQjIFR5cGVIYW5kbGVyUmVnaXN0cnkgdHlwZUhhbmRsZXJSZWdpc3RyeVxufVxubm90ZSBsZWZ0IG9mIEJhc2VCdWlsZGVyOjpjb25maWd1cmF0aW9uXG4gIOmcgOimgeWwhlhNTOaWh-S7tuS4reeahOmFjee9ruaYoOWwhOWIsOivpeexu-S4rVxuZW5kIG5vdGVcbm5vdGUgbGVmdCBvZiBCYXNlQnVpbGRlcjo6dHlwZUFsaWFzUmVnaXN0cnlcbiAg5Yir5ZCN5rOo5YaM5Zmo77yM55So5LqO5Zyo6YWN572u5Lit6L-b6KGM57yp5YaZ44CCXG5lbmQgbm90ZVxubm90ZSBsZWZ0IG9mIEJhc2VCdWlsZGVyOjp0eXBlSGFuZGxlclJlZ2lzdHJ5XG4gIOexu-Wei-WkhOeQhuWZqO-8jOeUqOS6juWwhkphdmHnsbvlnosgPC0tPiBKREJD57G75Z6L77yM55u45LqS6L2s5o2i44CCXG5lbmQgbm90ZVxuXG5jbGFzcyBYTUxDb25maWdCdWlsZGVye1xuXHQrIENvbmZpZ3VyYXRpb24gcGFyc2UoKVxuXHQtIHZvaWQgcGFyc2VDb25maWd1cmF0aW9uKFhOb2RlIHJvb3QpXG59XG5ub3RlIGxlZnQgb2YgWE1MQ29uZmlnQnVpbGRlcjo6cGFyc2VcbiAg6Kej5p6Q6YWN572u77yM6L-U5ZueQ29uZmlndXJhdGlvblxuZW5kIG5vdGVcbm5vdGUgbGVmdCBvZiBYTUxDb25maWdCdWlsZGVyOjpwYXJzZUNvbmZpZ3VyYXRpb25cbiAg6Kej5p6Q6YWN572u77yM6YWN572u5pig5bCE5YiwQ29uZmlndXJhdGlvblxuZW5kIG5vdGVcbkBlbmR1bWwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sL2E1Nzc4NWI5MzhhYzMxYmJlYmYzN2IzYzUyMGQ3NzQ5LnN2ZyIsImlkIjoiQ2x2NDkiLCJtYXJnaW4iOnsidG9wIjp0cnVlLCJib3R0b20iOnRydWV9LCJjYXJkIjoiZGlhZ3JhbSJ9">TypeAliasRegistry：在Configuration中默认创建，<a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#typeAliases">配置参考</a>。<br>TypeHandlerRegistry：在Configuration中默认创建，<a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#typeHandlers">配置参考</a>。<br>​</p>
<p>实际处理XML中<strong>Configuration</strong>节点由**parseConfiguration(…)**方法，我们从这个方法开始。</p>
<h2 id="2-属性（properties）"><a href="#2-属性（properties）" class="headerlink" title="2. 属性（properties）"></a>2. 属性（properties）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#properties">配置参考</a>，方便编写配置，进行动态替换，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;config.properties&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span>    <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis-test?characterEncoding=utf8<span class="symbol">&amp;amp;</span>zeroDateTimeBehavior=convertToNull<span class="symbol">&amp;amp;</span>useSSL=false<span class="symbol">&amp;amp;</span>useJDBCCompliantTimezoneShift=true<span class="symbol">&amp;amp;</span>useLegacyDatetimeCode=false<span class="symbol">&amp;amp;</span>serverTimezone=GMT%2B8<span class="symbol">&amp;amp;</span>allowMultiQueries=true<span class="symbol">&amp;amp;</span>allowPublicKeyRetrieval=true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># config.<span class="type">properties</span></span><br><span class="line"><span class="variable">username</span> <span class="operator">=</span> <span class="type">root</span></span><br><span class="line"><span class="variable">password</span> <span class="operator">=</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>配置属性有三种方法：</p>
<ol>
<li>直接在properties节点中定义property。</li>
<li>properties标签resource属性。</li>
<li>properties标签url属性。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root.evalNode会将占位符解析成属性</span></span><br><span class="line">propertiesElement(root.evalNode(<span class="string">&quot;properties&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">propertiesElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 在properties节点中定义的属性</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">defaults</span> <span class="operator">=</span> context.getChildrenAsProperties();</span><br><span class="line">        <span class="comment">// 配置在资源文件中。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        <span class="comment">// 从网络中获取资源文件</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="literal">null</span> &amp;&amp; url != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="literal">null</span>) &#123;</span><br><span class="line">            defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url != <span class="literal">null</span>) &#123;</span><br><span class="line">            defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">vars</span> <span class="operator">=</span> configuration.getVariables();</span><br><span class="line">        <span class="keyword">if</span> (vars != <span class="literal">null</span>) &#123;</span><br><span class="line">            defaults.putAll(vars);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注意，evalNode调用时会尝试从variables中读取变量</span></span><br><span class="line">        parser.setVariables(defaults);</span><br><span class="line">        <span class="comment">// 设置变量</span></span><br><span class="line">        configuration.setVariables(defaults);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
实际上在调用<strong>evalNode()<strong>方法时已经用到了</strong>properties</strong>：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 比如getStringAttribute, attributes = parseAttributes(node);</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getStringAttribute</span><span class="params">(String name, Supplier&lt;String&gt; defSupplier)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> attributes.getProperty(name);</span><br><span class="line">    <span class="keyword">return</span> value == <span class="literal">null</span> ? defSupplier.get() : value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析属性</span></span><br><span class="line"><span class="keyword">private</span> Properties <span class="title function_">parseAttributes</span><span class="params">(Node n)</span> &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">attributes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    <span class="type">NamedNodeMap</span> <span class="variable">attributeNodes</span> <span class="operator">=</span> n.getAttributes();</span><br><span class="line">    <span class="keyword">if</span> (attributeNodes != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; attributeNodes.getLength(); i++) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">attribute</span> <span class="operator">=</span> attributeNodes.item(i);</span><br><span class="line">            <span class="comment">// variables</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> PropertyParser.parse(attribute.getNodeValue(), variables);</span><br><span class="line">            attributes.put(attribute.getNodeName(), value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> attributes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="3-设置（settings）"><a href="#3-设置（settings）" class="headerlink" title="3. 设置（settings）"></a>3. 设置（settings）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#settings">配置参考</a>，设置启动 &#x2F; 关闭功能，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;cacheEnabled&quot;</span>        <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;defaultExecutorType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SIMPLE&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>设置属性太多，以这两个举例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析XML配置</span></span><br><span class="line"><span class="type">Properties</span> <span class="variable">settings</span> <span class="operator">=</span> settingsAsProperties(root.evalNode(<span class="string">&quot;settings&quot;</span>));</span><br><span class="line"><span class="comment">// 设置VFS的实现</span></span><br><span class="line">loadCustomVfs(settings);</span><br><span class="line"><span class="comment">// 设置自定义日志</span></span><br><span class="line">loadCustomLogImpl(settings);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 配置设置默认属性</span></span><br><span class="line">settingsElement(settings);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Properties <span class="title function_">settingsAsProperties</span><span class="params">(XNode context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取配置信息</span></span><br><span class="line">    <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> context.getChildrenAsProperties();</span><br><span class="line">    <span class="comment">// Check that all settings are known to the configuration class</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证 Configuration中是否存在setting标签中set name属性方法。</span></span><br><span class="line">    <span class="type">MetaClass</span> <span class="variable">metaConfig</span> <span class="operator">=</span> MetaClass.forClass(Configuration.class, localReflectorFactory);</span><br><span class="line">    <span class="keyword">for</span> (Object key : props.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!metaConfig.hasSetter(String.valueOf(key))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;The setting &quot;</span> + key + <span class="string">&quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-类型别名（typeAliases）"><a href="#4-类型别名（typeAliases）" class="headerlink" title="4. 类型别名（typeAliases）"></a>4. 类型别名（typeAliases）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#typeAliases">配置参考</a>，设置缩写的别名，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">&quot;student&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.example.entity.StudentEntity&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.example.entity&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>XMLConfigBuilder UML图中展示了<strong>Configuration</strong>类中有一个成员变量：<strong>TypeAliasRegistry</strong>，我相信大家已经想到了Mybatis是如何做的？<br>但需要一点注意，别名注册有两种形式：</p>
<ol>
<li>package：该包名下Java Bean都会注册别名（具体请看配置参考）。</li>
<li>typeAlias：单个类注册别民。</li>
</ol>
<p>Mybatis已经帮我注册了一些常用的别名，如：int、long…。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">typeAliasesElement(root.evalNode(<span class="string">&quot;typeAliases&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">typeAliasesElement</span><span class="params">(XNode parent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            <span class="comment">// 把整个包名下所有对象注册别名</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">typeAliasPackage</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 单个对象注册</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">alias</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;alias&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">                    <span class="keyword">if</span> (alias == <span class="literal">null</span>) &#123;</span><br><span class="line">                        typeAliasRegistry.registerAlias(clazz);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        typeAliasRegistry.registerAlias(alias, clazz);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error registering typeAlias for &#x27;&quot;</span> + alias + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="5-类型处理器（typeHandlers）"><a href="#5-类型处理器（typeHandlers）" class="headerlink" title="5. 类型处理器（typeHandlers）"></a>5. 类型处理器（typeHandlers）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#typeHandlers">配置参考</a>，TypeHandler相对复杂，用于Statement参数映射、ResultSet返回处理。将Java Type 与 JDBC Type相互转换，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;com.example.handler.ExampleTypeHandler&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@MappedJdbcTypes(JdbcType.VARCHAR)</span><br><span class="line">public class ExampleTypeHandler extends BaseTypeHandler<span class="tag">&lt;<span class="name">String</span>&gt;</span> &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void setNonNullParameter(PreparedStatement ps, int i, String parameter, JdbcType jdbcType) throws SQLException &#123;</span><br><span class="line">        ps.setString(i, parameter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getNullableResult(ResultSet rs, String columnName) throws SQLException &#123;</span><br><span class="line">        return rs.getString(columnName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getNullableResult(ResultSet rs, int columnIndex) throws SQLException &#123;</span><br><span class="line">        return rs.getString(columnIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getNullableResult(CallableStatement cs, int columnIndex) throws SQLException &#123;</span><br><span class="line">        return cs.getString(columnIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和<strong>类型别名</strong>大体相同，同样支持两种方式，注册与<strong>类型别名</strong>相差无几，所以在此省略。</p>
<h2 id="6-对象工厂（objectFactory）"><a href="#6-对象工厂（objectFactory）" class="headerlink" title="6. 对象工厂（objectFactory）"></a>6. 对象工厂（objectFactory）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#objectFactory">配置参考</a>，<strong>DefaultResultSetHandler</strong>会在处理<strong>结果集</strong>时使用对象工厂创建返回对象，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">objectFactory</span> <span class="attr">type</span>=<span class="string">&quot;com.example.handler.ExampleObjectFactory&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;someProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">objectFactory</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleObjectFactory</span> <span class="keyword">extends</span> <span class="title class_">DefaultObjectFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">create</span><span class="params">(Class type)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.create(type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">        System.out.println(properties);</span><br><span class="line">        <span class="built_in">super</span>.setProperties(properties);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="type">boolean</span> <span class="title function_">isCollection</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collection.class.isAssignableFrom(type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// print</span></span><br><span class="line"><span class="comment">// -------------------------------</span></span><br><span class="line">&#123;someProperty=<span class="number">100</span>&#125;</span><br><span class="line"><span class="comment">// -------------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>ObjectFactory</strong>比较简单，默认实现为<strong>DefaultObjectFactory</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">objectFactoryElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> context.getChildrenAsProperties();</span><br><span class="line">        <span class="comment">// 根据类型，创建ExampleObjectFactory</span></span><br><span class="line">        <span class="type">ObjectFactory</span> <span class="variable">factory</span> <span class="operator">=</span> (ObjectFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">        <span class="comment">// 调用set方法</span></span><br><span class="line">        factory.setProperties(properties);</span><br><span class="line">        <span class="comment">// 设置到configuration中</span></span><br><span class="line">        configuration.setObjectFactory(factory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-插件（plugins）"><a href="#7-插件（plugins）" class="headerlink" title="7. 插件（plugins）"></a>7. 插件（plugins）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#plugins">配置参考</a>，Mybatis plugin提供的功能非常强大，可以实现相当丰富的功能。如：PageHelper（分页工具），强烈建议参考文档学习，对于一些特定的场景有奇效。配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">&quot;com.github.pagehelper.PageInterceptor&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以PageHelper为例，注意plugin节点中可以和<strong>objectFactory</strong>一样配置<strong>property</strong>标签，我在这里并没有体现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pluginElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">interceptor</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;interceptor&quot;</span>);</span><br><span class="line">            <span class="comment">// plugin -&gt; property</span></span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> child.getChildrenAsProperties();</span><br><span class="line">            <span class="comment">// 创建plugin 拦截器</span></span><br><span class="line">            <span class="type">Interceptor</span> <span class="variable">interceptorInstance</span> <span class="operator">=</span> (Interceptor) resolveClass(interceptor).getDeclaredConstructor().newInstance();</span><br><span class="line">            interceptorInstance.setProperties(properties);</span><br><span class="line">            <span class="comment">// 添加到configuration拦截器链中</span></span><br><span class="line">            configuration.addInterceptor(interceptorInstance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-environments（环境配置）"><a href="#8-environments（环境配置）" class="headerlink" title="8. environments（环境配置）"></a>8. environments（环境配置）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#environments">配置参考</a>，提供三个功能：</p>
<ol>
<li>配置事务管理器</li>
</ol>
<p>提供事务管理，比如：<strong>Executor</strong>提供<strong>commit</strong>、<strong>rollback</strong>等事务方法，实际上由<strong>Transaction</strong>执行。</p>
<ol start="2">
<li>配置数据源</li>
</ol>
<p>配置数据源，可选择具体数据库连接池（这里默认Mybatis自带）。</p>
<ol start="3">
<li>支持切换环境</li>
</ol>
<p>发布不同版本，切换不同的环境。<br>配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这里选择JBDC事务管理器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>根据设置默认环境，选择读取哪一个环境。<br>创建事务管理工厂、数据源工厂，设值进configuration成员中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">environmentsElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (environment == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取当前环境名称</span></span><br><span class="line">            environment = context.getStringAttribute(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (XNode child : context.getChildren()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">            <span class="comment">// 判断当前默认环境 和 environmentId是否相同 </span></span><br><span class="line">            <span class="keyword">if</span> (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">                <span class="comment">// 解析事务管理，创建TransactionFactory实例</span></span><br><span class="line">                <span class="type">TransactionFactory</span> <span class="variable">txFactory</span> <span class="operator">=</span> transactionManagerElement(child.evalNode(<span class="string">&quot;transactionManager&quot;</span>));</span><br><span class="line">                <span class="comment">// 解析数据源</span></span><br><span class="line">                <span class="type">DataSourceFactory</span> <span class="variable">dsFactory</span> <span class="operator">=</span> dataSourceElement(child.evalNode(<span class="string">&quot;dataSource&quot;</span>));</span><br><span class="line">                <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> dsFactory.getDataSource();</span><br><span class="line">                <span class="comment">// 构建环境</span></span><br><span class="line">                Environment.<span class="type">Builder</span> <span class="variable">environmentBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Environment</span>.Builder(id)</span><br><span class="line">                    .transactionFactory(txFactory)</span><br><span class="line">                    .dataSource(dataSource);</span><br><span class="line">                <span class="comment">// 赋值</span></span><br><span class="line">                configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-databaseIdProvider（数据库厂商标识）"><a href="#9-databaseIdProvider（数据库厂商标识）" class="headerlink" title="9. databaseIdProvider（数据库厂商标识）"></a>9. databaseIdProvider（数据库厂商标识）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#environments">配置参考</a>，根据不同数据库，可以选择不同的MappedStatement，不是很好用。配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">databaseIdProvider</span> <span class="attr">type</span>=<span class="string">&quot;DB_VENDOR&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;MySQL&quot;</span> <span class="attr">value</span>=<span class="string">&quot;mysql&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;Oracle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;oracle&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">databaseIdProvider</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectOne&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.entity.StudentEntity&quot;</span> <span class="attr">databaseId</span>=<span class="string">&quot;mysql&quot;</span>&gt;</span></span><br><span class="line">  select id, name from student</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectOne&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.entity.StudentEntity&quot;</span> <span class="attr">databaseId</span>=<span class="string">&quot;oracle&quot;</span>&gt;</span></span><br><span class="line">  select id, name from student</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>只能设置单个数据源databaseId，如果想用多数据源，得创建多个SqlSessionFactory做切换。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">databaseIdProviderElement(root.evalNode(<span class="string">&quot;databaseIdProvider&quot;</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">databaseIdProviderElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">DatabaseIdProvider</span> <span class="variable">databaseIdProvider</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        <span class="comment">// awful patch to keep backward compatibility</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;VENDOR&quot;</span>.equals(type)) &#123;</span><br><span class="line">            type = <span class="string">&quot;DB_VENDOR&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> context.getChildrenAsProperties();</span><br><span class="line">        <span class="comment">// 创建VendorDatabaseIdProvider对象</span></span><br><span class="line">        databaseIdProvider = (DatabaseIdProvider) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">        databaseIdProvider.setProperties(properties);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> configuration.getEnvironment();</span><br><span class="line">    <span class="keyword">if</span> (environment != <span class="literal">null</span> &amp;&amp; databaseIdProvider != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 设置当前数据源 对于databaseId</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">databaseId</span> <span class="operator">=</span> databaseIdProvider.getDatabaseId(environment.getDataSource());</span><br><span class="line">        configuration.setDatabaseId(databaseId);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="10-mappers（映射器）"><a href="#10-mappers（映射器）" class="headerlink" title="10. mappers（映射器）"></a>10. mappers（映射器）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/configuration.html#mappers">配置参考</a>，告诉Mybatis去哪里寻找Mapper文件进行注册。配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;StudentMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 官网用例 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">&quot;file:///var/mappers/BlogMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.builder.BlogMapper&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;org.mybatis.builder&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="11-autoMapping（自动映射）"><a href="#11-autoMapping（自动映射）" class="headerlink" title="11. autoMapping（自动映射）"></a>11. autoMapping（自动映射）</h2><p>可以区分为两大类：</p>
<ol>
<li>XML：resource（资源路径）、url（URL）。</li>
<li>Annotation：class（类路径）、package（包名下）。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mapperElement(root.evalNode(<span class="string">&quot;mappers&quot;</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            <span class="comment">// 1. 注解模式：把整个包名下注册Mapper</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">mapperPackage</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                configuration.addMappers(mapperPackage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">mapperClass</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">                <span class="comment">// 2. XML 资源目录</span></span><br><span class="line">                <span class="keyword">if</span> (resource != <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ErrorContext.instance().resource(resource);</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line">                    <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="comment">// 3. XML URL</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url != <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ErrorContext.instance().resource(url);</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getUrlAsStream(url);</span><br><span class="line">                    <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="comment">// 4. 注解 单个</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass != <span class="literal">null</span>) &#123;</span><br><span class="line">                    Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">                    configuration.addMapper(mapperInterface);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>到此处，整个MybatisConfig全部完成工作，下面开始解析Mapper。</p>
<h1 id="三、解析Mapper"><a href="#三、解析Mapper" class="headerlink" title="三、解析Mapper"></a>三、解析Mapper</h1><h2 id="1-XMLMapperBuilder"><a href="#1-XMLMapperBuilder" class="headerlink" title="1. XMLMapperBuilder"></a>1. XMLMapperBuilder</h2><p><img src="https://cdn.nlark.com/yuque/__puml/9ddf552a8aec9d85f16a7cbbdc9cdb64.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYWJzdHJhY3QgY2xhc3MgQmFzZUJ1aWxkZXJcbmNsYXNzIFhNTE1hcHBlckJ1aWxkZXIgZXh0ZW5kcyBCYXNlQnVpbGRlciBcbmNsYXNzIE1hcHBlckJ1aWxkZXJBc3Npc3RhbnRcbm5vdGUgbGVmdDogTWFwcGVy5p6E5bu65Yqp5omL77yM55So5LqO5LiA5Lqb5aSE55CGTWFwcGVy5qCH562-55qE5bel5L2c77yM5bCG5aSE55CG57uT5p6c6K6-572u6L-bQ29uZmlndXJhdGlvbuS4reOAglxuXG5CYXNlQnVpbGRlciA8fC0tIE1hcHBlckJ1aWxkZXJBc3Npc3RhbnRcblhNTE1hcHBlckJ1aWxkZXIgKi0tIE1hcHBlckJ1aWxkZXJBc3Npc3RhbnRcblxuYWJzdHJhY3QgY2xhc3MgQmFzZUJ1aWxkZXJ7XG5cdCMgQ29uZmlndXJhdGlvbiBjb25maWd1cmF0aW9uXG5cdCMgVHlwZUFsaWFzUmVnaXN0cnkgdHlwZUFsaWFzUmVnaXN0cnlcblx0IyBUeXBlSGFuZGxlclJlZ2lzdHJ5IHR5cGVIYW5kbGVyUmVnaXN0cnlcbn1cblxuY2xhc3MgWE1MTWFwcGVyQnVpbGRlcntcblx0KyB2b2lkIHBhcnNlKClcblx0LSB2b2lkIGNvbmZpZ3VyYXRpb25FbGVtZW50KFhOb2RlIHJvb3QpXG59XG5ub3RlIGxlZnQgb2YgQmFzZUJ1aWxkZXI6OmNvbmZpZ3VyYXRpb25cbiAg6ZyA6KaB5bCGWE1M5paH5Lu25Lit55qE6YWN572u5pig5bCE5Yiw6K-l57G75LitXG5lbmQgbm90ZVxubm90ZSBsZWZ0IG9mIEJhc2VCdWlsZGVyOjp0eXBlQWxpYXNSZWdpc3RyeVxuICDliKvlkI3ms6jlhozlmajvvIznlKjkuo7lnKjphY3nva7kuK3ov5vooYznvKnlhpnjgIJcbmVuZCBub3RlXG5ub3RlIGxlZnQgb2YgQmFzZUJ1aWxkZXI6OnR5cGVIYW5kbGVyUmVnaXN0cnlcbiAg57G75Z6L5aSE55CG5Zmo77yM55So5LqO5bCGSmF2Yeexu-WeiyA8LS0-IEpEQkPnsbvlnovvvIznm7jkupLovazmjaLjgIJcbmVuZCBub3RlXG5ub3RlIGxlZnQgb2YgWE1MTWFwcGVyQnVpbGRlcjo6cGFyc2VcbiAg6Kej5p6Q6YWN572uXG5lbmQgbm90ZVxubm90ZSBsZWZ0IG9mIFhNTE1hcHBlckJ1aWxkZXI6OmNvbmZpZ3VyYXRpb25FbGVtZW50XG4gIOino-aekOmFjee9ru-8jOmFjee9ruaYoOWwhOWIsENvbmZpZ3VyYXRpb25cbmVuZCBub3RlXG5AZW5kdW1sIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC85ZGRmNTUyYThhZWM5ZDg1ZjE2YTdjYmJkYzljZGI2NC5zdmciLCJpZCI6Im5VNm9FIiwibWFyZ2luIjp7InRvcCI6dHJ1ZSwiYm90dG9tIjp0cnVlfSwiY2FyZCI6ImRpYWdyYW0ifQ=="><strong>parse</strong>方法与XMLConfigBuilder有所不同。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// resource 是否加载过</span></span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">        <span class="comment">// 解析Mapper标签</span></span><br><span class="line">        configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">        <span class="comment">// 添加到加载后集合</span></span><br><span class="line">        configuration.addLoadedResource(resource);</span><br><span class="line">        <span class="comment">// 主要责任将Mapper加载到configuration，Mapper注册器中。</span></span><br><span class="line">        bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 错误重新解析，有些先后初始化顺序会导致解析失败，此时在重新解析一遍。</span></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-cache（缓存）"><a href="#2-cache（缓存）" class="headerlink" title="2. cache（缓存）"></a>2. cache（缓存）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html#cache">配置参考</a>，Mybatis一级缓存默认开启，二级缓存需要手动配置开启。<br>区别：<br>一级缓存：作用域Statement，多个Statement不共享。<br>二级缓存：作用域namespace，同一个namespace中Statement共享同一个缓存。有缓存淘汰机制，支持定制化操作。<br>配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>二级缓存使用条件较为苛刻，一般不启动，以最简单的默认配置进行分析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cacheElement</span><span class="params">(XNode context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取缓存类型，这里以默认为例：PERPETUAL</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;PERPETUAL&quot;</span>);</span><br><span class="line">        <span class="comment">// 从别名注册器中找到该名称对应的类型</span></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">Cache</span>&gt; typeClass = typeAliasRegistry.resolveAlias(type);</span><br><span class="line">        <span class="comment">// 获取缓存获取策略， 默认LRU</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">eviction</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;eviction&quot;</span>, <span class="string">&quot;LRU&quot;</span>);</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">Cache</span>&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction);</span><br><span class="line">        <span class="comment">// 刷新间隔</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">flushInterval</span> <span class="operator">=</span> context.getLongAttribute(<span class="string">&quot;flushInterval&quot;</span>);</span><br><span class="line">        <span class="comment">// 引用数目</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">size</span> <span class="operator">=</span> context.getIntAttribute(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        <span class="comment">// 只读</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">readWrite</span> <span class="operator">=</span> !context.getBooleanAttribute(<span class="string">&quot;readOnly&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">blocking</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;blocking&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> context.getChildrenAsProperties();</span><br><span class="line">        <span class="comment">// 使用助手创建缓存对象，并放到Configuration中，同时放到currentCache成员变量中，方便解析Statement使用。</span></span><br><span class="line">        builderAssistant.useNewCache(typeClass, evictionClass, flushInterval, size, readWrite, blocking, props);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-cache-ref（缓存引用）"><a href="#3-cache-ref（缓存引用）" class="headerlink" title="3. cache-ref（缓存引用）"></a>3. cache-ref（缓存引用）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html#cache-ref">配置参考</a>，使多个namespace共用一个cache。有几个要注意的地方：</p>
<ol>
<li>cache配置会覆盖cache-ref（由于执行顺序cache-ref总是被先执行）</li>
<li>如果使用cache-ref，如果引用Mapper在此时还没有初始化，解析cache-ref、解析Statement将在后续的错误尝试中执行。</li>
</ol>
<p>配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache-ref</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.TestMapper&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>涉及到缓存依赖问题，如果依赖的缓存还没有创建怎么办？<br>Mybatis选择在后续处理，而不是JVM &#x2F; SpringBean 加载类时进行交叉加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cacheRefElement</span><span class="params">(XNode context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 添加configuration</span></span><br><span class="line">        configuration.addCacheRef(builderAssistant.getCurrentNamespace(), context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>));</span><br><span class="line">        <span class="type">CacheRefResolver</span> <span class="variable">cacheRefResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CacheRefResolver</span>(builderAssistant, context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 解析cache-ref</span></span><br><span class="line">            cacheRefResolver.resolveCacheRef();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">            configuration.addIncompleteCacheRef(cacheRefResolver);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过了一些方法</span></span><br><span class="line"><span class="keyword">public</span> Cache <span class="title function_">resolveCacheRef</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (namespace == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;cache-ref element requires a namespace attribute.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 未解决缓存引用 true，需要后续处理</span></span><br><span class="line">        unresolvedCacheRef = <span class="literal">true</span>;</span><br><span class="line">        <span class="type">Cache</span> <span class="variable">cache</span> <span class="operator">=</span> configuration.getCache(namespace);</span><br><span class="line">        <span class="keyword">if</span> (cache == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteElementException</span>(<span class="string">&quot;No cache for namespace &#x27;&quot;</span> + namespace + <span class="string">&quot;&#x27; could be found.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 这个字段用于后续statement处理缓存</span></span><br><span class="line">        currentCache = cache;</span><br><span class="line">         <span class="comment">// 缓存引用已存在，必须要错误处理</span></span><br><span class="line">        unresolvedCacheRef = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> cache;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteElementException</span>(<span class="string">&quot;No cache for namespace &#x27;&quot;</span> + namespace + <span class="string">&quot;&#x27; could be found.&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-resultMap（结果映射）"><a href="#4-resultMap（结果映射）" class="headerlink" title="4. resultMap（结果映射）"></a>4. resultMap（结果映射）</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html#Result_Maps">配置参考</a>，查询返回结果集进行映射。支持复杂结果处理，有四种方式：</p>
<ol>
<li>constructor： 调用构造方法</li>
<li>association： 一对一</li>
<li>collection: 一对多</li>
<li>discriminator： 根据匹配字段的value，使用结果值来决定使用哪个 resultMapresult</li>
</ol>
<h3 id="1-支持功能"><a href="#1-支持功能" class="headerlink" title="1. 支持功能"></a>1. 支持功能</h3><p>默认的子节点：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">id</span>     <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>   <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>id</strong>：一个 ID 结果；标记出作为 ID 的结果可以帮助提高整体性能<br><strong>result</strong>：注入到字段或 JavaBean 属性的普通结果</p>
<h4 id="1-constructor"><a href="#1-constructor" class="headerlink" title="1.  constructor"></a>1.  constructor</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;map&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.example.entity.StudentEntity&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">idArg</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>   <span class="attr">name</span>=<span class="string">&quot;id&quot;</span>   <span class="attr">javaType</span>=<span class="string">&quot;long&quot;</span>   /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">arg</span>   <span class="attr">column</span>=<span class="string">&quot;name&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;string&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>constructor：拥有idArg、arg两个子节点，<br>在对结果集进行映射后，会调用构造方法进行创建对象。<br>需要注意一点：如果使用了该功能，java一般情况下反射是无法获取到形参名称，有两种解决方案：</p>
<ol>
<li><p>添加 @Param 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">StudentEntity</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id, <span class="meta">@Param(&quot;name&quot;)</span> String name)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.id = id;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启编译选项**-parameter**</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8/<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="2-association"><a href="#2-association" class="headerlink" title="2. association"></a>2. association</h4><p>江湖人称：一对一关联关系，可嵌套。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">&quot;child&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;com.example.entity.T4Entity&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>     <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>       <span class="attr">column</span>=<span class="string">&quot;id5&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;username&quot;</span> <span class="attr">column</span>=<span class="string">&quot;name5&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT <span class="keyword">association</span> (<span class="keyword">constructor</span>?,<span class="keyword">id</span>*,<span class="keyword">result</span>*,<span class="keyword">association</span>*,<span class="keyword">collection</span>*, <span class="keyword">discriminator</span>?)&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="3-collection"><a href="#3-collection" class="headerlink" title="3. collection"></a>3. collection</h4><p>江湖人称：一对多关联关系，可嵌套。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;childList&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;com.example.entity.T5Entity&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>        <span class="attr">column</span>=<span class="string">&quot;id5&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;username&quot;</span>  <span class="attr">column</span>=<span class="string">&quot;name5&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="4-discriminator"><a href="#4-discriminator" class="headerlink" title="4.discriminator"></a>4.discriminator</h4><p>监听器：根据字段的值case匹配的value返回不同的对象。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">discriminator</span> <span class="attr">javaType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.entity.T1Entity&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.entity.T2Entity&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">resultMap</span> =<span class="string">&quot;map&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-功能解析"><a href="#2-功能解析" class="headerlink" title="2.功能解析"></a>2.功能解析</h3><h4 id="1-解析resultMap"><a href="#1-解析resultMap" class="headerlink" title="1. 解析resultMap"></a>1. 解析resultMap</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ResultMap <span class="title function_">resultMapElement</span><span class="params">(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings, Class&lt;?&gt; enclosingType)</span> &#123;</span><br><span class="line">  ErrorContext.instance().activity(<span class="string">&quot;processing &quot;</span> + resultMapNode.getValueBasedIdentifier());</span><br><span class="line">  <span class="comment">// 获取标注的type名称</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> resultMapNode.getStringAttribute(<span class="string">&quot;type&quot;</span>,</span><br><span class="line">      resultMapNode.getStringAttribute(<span class="string">&quot;ofType&quot;</span>,</span><br><span class="line">          resultMapNode.getStringAttribute(<span class="string">&quot;resultType&quot;</span>,</span><br><span class="line">              resultMapNode.getStringAttribute(<span class="string">&quot;javaType&quot;</span>))));</span><br><span class="line">  <span class="comment">// 根据type名称获取class对象，因为可以缩写，需要别名注册器查询。</span></span><br><span class="line">  Class&lt;?&gt; typeClass = resolveClass(type);</span><br><span class="line">  <span class="keyword">if</span> (typeClass == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 处理没填resultMap</span></span><br><span class="line">    typeClass = inheritEnclosingType(resultMapNode, enclosingType);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 鉴定器，用来选择返回值的类型</span></span><br><span class="line">  <span class="type">Discriminator</span> <span class="variable">discriminator</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 核心类，返回映射。resultSetHandler就是用这个来把结果集转换成指定的类型</span></span><br><span class="line">  List&lt;ResultMapping&gt; resultMappings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(additionalResultMappings);</span><br><span class="line">  <span class="comment">// 开始解析子节点</span></span><br><span class="line">  List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();</span><br><span class="line">  <span class="keyword">for</span> (XNode resultChild : resultChildren) &#123;</span><br><span class="line">    <span class="comment">// 解析构造方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;constructor&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">      processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析鉴定器</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;discriminator&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">      discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// id、result、collection</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      List&lt;ResultFlag&gt; flags = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;id&quot;</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">        flags.add(ResultFlag.ID);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//构建resultMapping,添加到集合中</span></span><br><span class="line">      resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> resultMapNode.getStringAttribute(<span class="string">&quot;id&quot;</span>,</span><br><span class="line">          resultMapNode.getValueBasedIdentifier());</span><br><span class="line">  <span class="comment">// 有没有继承</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">extend</span> <span class="operator">=</span> resultMapNode.getStringAttribute(<span class="string">&quot;extends&quot;</span>);</span><br><span class="line">  <span class="comment">// 有没有自动映射</span></span><br><span class="line">  <span class="type">Boolean</span> <span class="variable">autoMapping</span> <span class="operator">=</span> resultMapNode.getBooleanAttribute(<span class="string">&quot;autoMapping&quot;</span>);</span><br><span class="line">  <span class="type">ResultMapResolver</span> <span class="variable">resultMapResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultMapResolver</span>(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> resultMapResolver.resolve();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">    configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-处理constructor"><a href="#2-处理constructor" class="headerlink" title="2. 处理constructor"></a>2. 处理constructor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processConstructorElement</span><span class="params">(XNode resultChild, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> &#123;</span><br><span class="line">  List&lt;XNode&gt; argChildren = resultChild.getChildren();</span><br><span class="line">  <span class="comment">// 遍历constructor下元素</span></span><br><span class="line">  <span class="keyword">for</span> (XNode argChild : argChildren) &#123;</span><br><span class="line">    List&lt;ResultFlag&gt; flags = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    flags.add(ResultFlag.CONSTRUCTOR);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;idArg&quot;</span>.equals(argChild.getName())) &#123;</span><br><span class="line">      flags.add(ResultFlag.ID);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加到集合中</span></span><br><span class="line">    resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-处理-x2F-构建鉴别器"><a href="#3-处理-x2F-构建鉴别器" class="headerlink" title="3. 处理 &#x2F; 构建鉴别器"></a>3. 处理 &#x2F; 构建鉴别器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Discriminator <span class="title function_">processDiscriminatorElement</span><span class="params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">column</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;column&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">javaType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;javaType&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">jdbcType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;jdbcType&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">typeHandler</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;typeHandler&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// resolveClass 基本都是使用别名注册器获取</span></span><br><span class="line">  Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">  Class&lt;? <span class="keyword">extends</span> <span class="title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerClass = resolveClass(typeHandler);</span><br><span class="line">    </span><br><span class="line">  <span class="type">JdbcType</span> <span class="variable">jdbcTypeEnum</span> <span class="operator">=</span> resolveJdbcType(jdbcType);</span><br><span class="line">  Map&lt;String, String&gt; discriminatorMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 解析case元素</span></span><br><span class="line">  <span class="comment">// case元素同样可以有id 、result</span></span><br><span class="line">  <span class="keyword">for</span> (XNode caseChild : context.getChildren()) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> caseChild.getStringAttribute(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="comment">// 如果case元素的属性是resultMap, 会再次调用resultMapElement方法（注意这里会递归调用，这里很重要！！！）</span></span><br><span class="line">    <span class="comment">// 这个方法请看4</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">resultMap</span> <span class="operator">=</span> caseChild.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>, processNestedResultMappings(caseChild, resultMappings, resultType));</span><br><span class="line">    discriminatorMap.put(value, resultMap);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 构建一个鉴别器</span></span><br><span class="line">  <span class="keyword">return</span> builderAssistant.buildDiscriminator(resultType, column, javaTypeClass, jdbcTypeEnum, typeHandlerClass, discriminatorMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-处理-id-x2F-result-x2F-collection"><a href="#4-处理-id-x2F-result-x2F-collection" class="headerlink" title="4. 处理 id &#x2F; result &#x2F; collection"></a>4. 处理 id &#x2F; result &#x2F; collection</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ResultMapping <span class="title function_">buildResultMappingFromContext</span><span class="params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags)</span> &#123;</span><br><span class="line">    String property;</span><br><span class="line">    <span class="keyword">if</span> (flags.contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">        property = context.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        property = context.getStringAttribute(<span class="string">&quot;property&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">column</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;column&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">javaType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;javaType&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">jdbcType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;jdbcType&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">nestedSelect</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">    <span class="comment">// 如果元素属性同样使用了resultMap, 也会再次调用resultMapElement方法（注意这里会递归调用，这里很重要！！！）</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">nestedResultMap</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>, () -&gt; processNestedResultMappings(context, Collections.emptyList(), resultType));</span><br><span class="line">    <span class="type">String</span> <span class="variable">notNullColumn</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;notNullColumn&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">columnPrefix</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;columnPrefix&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">typeHandler</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;typeHandler&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultSet</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultSet&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">foreignColumn</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;foreignColumn&quot;</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">lazy</span> <span class="operator">=</span> <span class="string">&quot;lazy&quot;</span>.equals(context.getStringAttribute(<span class="string">&quot;fetchType&quot;</span>, configuration.isLazyLoadingEnabled() ? <span class="string">&quot;lazy&quot;</span> : <span class="string">&quot;eager&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 别名注册器获取</span></span><br><span class="line">    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerClass = resolveClass(typeHandler);</span><br><span class="line"></span><br><span class="line">    <span class="type">JdbcType</span> <span class="variable">jdbcTypeEnum</span> <span class="operator">=</span> resolveJdbcType(jdbcType);</span><br><span class="line">    <span class="keyword">return</span> builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resultSet, foreignColumn, lazy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理嵌套返回映射</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">processNestedResultMappings</span><span class="params">(XNode context, List&lt;ResultMapping&gt; resultMappings, Class&lt;?&gt; enclosingType)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Arrays.asList(<span class="string">&quot;association&quot;</span>, <span class="string">&quot;collection&quot;</span>, <span class="string">&quot;case&quot;</span>).contains(context.getName())</span><br><span class="line">        &amp;&amp; context.getStringAttribute(<span class="string">&quot;select&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">        validateCollection(context, enclosingType);</span><br><span class="line">        <span class="comment">// 这里会递归调用</span></span><br><span class="line">        <span class="type">ResultMap</span> <span class="variable">resultMap</span> <span class="operator">=</span> resultMapElement(context, resultMappings, enclosingType);</span><br><span class="line">        <span class="keyword">return</span> resultMap.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-构建ResultMapping"><a href="#5-构建ResultMapping" class="headerlink" title="5. 构建ResultMapping"></a>5. 构建ResultMapping</h4><p>不必太过研究，只需要有哪些成员有个印象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ResultMapping <span class="title function_">buildResultMapping</span><span class="params">(</span></span><br><span class="line"><span class="params">    Class&lt;?&gt; resultType,</span></span><br><span class="line"><span class="params">    String property,</span></span><br><span class="line"><span class="params">    String column,</span></span><br><span class="line"><span class="params">    Class&lt;?&gt; javaType,</span></span><br><span class="line"><span class="params">    JdbcType jdbcType,</span></span><br><span class="line"><span class="params">    // 需要select执行 MappedStatement</span></span><br><span class="line"><span class="params">    String nestedSelect,</span></span><br><span class="line"><span class="params">    // 需要注意一下，resultSetHandler解析需要嵌套执行</span></span><br><span class="line"><span class="params">    String nestedResultMap,</span></span><br><span class="line"><span class="params">    String notNullColumn,</span></span><br><span class="line"><span class="params">    String columnPrefix,</span></span><br><span class="line"><span class="params">    Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span></span><br><span class="line"><span class="params">    List&lt;ResultFlag&gt; flags,</span></span><br><span class="line"><span class="params">    String resultSet,</span></span><br><span class="line"><span class="params">    String foreignColumn,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> lazy)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; javaTypeClass = resolveResultJavaType(resultType, property, javaType);</span><br><span class="line">    TypeHandler&lt;?&gt; typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler);</span><br><span class="line">    List&lt;ResultMapping&gt; composites;</span><br><span class="line">    <span class="keyword">if</span> ((nestedSelect == <span class="literal">null</span> || nestedSelect.isEmpty()) &amp;&amp; (foreignColumn == <span class="literal">null</span> || foreignColumn.isEmpty())) &#123;</span><br><span class="line">        composites = Collections.emptyList();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        composites = parseCompositeColumnName(column);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResultMapping</span>.Builder(configuration, property, column, javaTypeClass)</span><br><span class="line">        .jdbcType(jdbcType)</span><br><span class="line">        .nestedQueryId(applyCurrentNamespace(nestedSelect, <span class="literal">true</span>))</span><br><span class="line">        .nestedResultMapId(applyCurrentNamespace(nestedResultMap, <span class="literal">true</span>))</span><br><span class="line">        .resultSet(resultSet)</span><br><span class="line">        .typeHandler(typeHandlerInstance)</span><br><span class="line">        .flags(flags == <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;() : flags)</span><br><span class="line">        .composites(composites)</span><br><span class="line">        .notNullColumns(parseMultipleColumnNames(notNullColumn))</span><br><span class="line">        .columnPrefix(columnPrefix)</span><br><span class="line">        .foreignColumn(foreignColumn)</span><br><span class="line">        .lazy(lazy)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-发现问题"><a href="#3-发现问题" class="headerlink" title="3. 发现问题"></a>3. 发现问题</h3><p>当<strong>constructor</strong>元素和<strong>discriminator case</strong>元素中<strong>resultMap</strong>属性同时使用，会导致创建<strong>resultMap</strong>, 获取构造方法名称没有类型导致NPE。<br>已经提交PR到<a target="_blank" rel="noopener" href="https://github.com/mybatis/mybatis-3">mybatis github</a>，目前还没有同意。<br><a target="_blank" rel="noopener" href="https://github.com/mybatis/mybatis-3/pull/2353">https://github.com/mybatis/mybatis-3/pull/2353</a></p>
<h2 id="5-sql"><a href="#5-sql" class="headerlink" title="5. sql"></a>5. sql</h2><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html#sql">配置参考</a>，可被其它语句引用的可重用语句块。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;sql id=<span class="string">&quot;userColumns&quot;</span>&gt; $&#123;alias&#125;.id,$&#123;alias&#125;.username,$&#123;alias&#125;.password &lt;/sql&gt;</span><br></pre></td></tr></table></figure>
<p>一般使用都是存放数据库的所有字段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;baseColumn&quot;</span>&gt;</span></span><br><span class="line">  t1.id, t1.account, t1.nick_name, t1.phone, t1.email, t1.pwd_reset_time, t1.avatar_name, t1.avatar_path, t1.status</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存放当前数据库厂商sql</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, XNode&gt; sqlFragments;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sqlElement</span><span class="params">(List&lt;XNode&gt; list)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (configuration.getDatabaseId() != <span class="literal">null</span>) &#123;</span><br><span class="line">        sqlElement(list, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    sqlElement(list, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sqlElement</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">        <span class="comment">// 隔离数据库厂商</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">databaseId</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="comment">// id = namespace + &quot;.&quot; + sql.id</span></span><br><span class="line">        id = builderAssistant.applyCurrentNamespace(id, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 判断当前数据库厂商和 sql属性databaseId 是否匹配</span></span><br><span class="line">        <span class="keyword">if</span> (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;</span><br><span class="line">            <span class="comment">// 存放到sqlFragments</span></span><br><span class="line">            sqlFragments.put(id, context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="四、解析Statement"><a href="#四、解析Statement" class="headerlink" title="四、解析Statement"></a>四、解析Statement</h1><p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html#select">配置参考</a>，解析Statement是在Mapper中解析的，由于篇幅过长，并且Statement很重要所有单独开一个小结。<br><strong>Statement</strong>：select、insert、update、delete四大标签，对于执行器来说只有<strong>Query</strong>和<strong>Update</strong>方法。具体的配置就不在阐述了。</p>
<h2 id="1-解析CRUD元素"><a href="#1-解析CRUD元素" class="headerlink" title="1. 解析CRUD元素"></a>1. 解析CRUD元素</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));</span><br></pre></td></tr></table></figure>
<h2 id="2-解析Statement节点"><a href="#2-解析Statement节点" class="headerlink" title="2. 解析Statement节点"></a>2. 解析Statement节点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseStatementNode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">databaseId</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;databaseId&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="built_in">this</span>.requiredDatabaseId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">nodeName</span> <span class="operator">=</span> context.getNode().getNodeName();</span><br><span class="line">    <span class="comment">// 区分 C、R、U、D 类型</span></span><br><span class="line">    <span class="type">SqlCommandType</span> <span class="variable">sqlCommandType</span> <span class="operator">=</span> SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSelect</span> <span class="operator">=</span> sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">    <span class="comment">// 是否刷新缓存，默认select不需要刷新，其他都需要</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flushCache</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;flushCache&quot;</span>, !isSelect);</span><br><span class="line">    <span class="comment">// 是否使用cache</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">useCache</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;useCache&quot;</span>, isSelect);</span><br><span class="line">    <span class="comment">// 一对多，collection 结果的笛卡尔积是否有序，可以减少缓存的对象。</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">resultOrdered</span> <span class="operator">=</span> context.getBooleanAttribute(<span class="string">&quot;resultOrdered&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Include Fragments before parsing</span></span><br><span class="line">    <span class="type">XMLIncludeTransformer</span> <span class="variable">includeParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLIncludeTransformer</span>(configuration, builderAssistant);</span><br><span class="line">    includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数类型</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">parameterType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;parameterType&quot;</span>);</span><br><span class="line">    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">lang</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line">    <span class="type">LanguageDriver</span> <span class="variable">langDriver</span> <span class="operator">=</span> getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// selectKey支持，可以查询某些数据，再set到insert / update语句中。</span></span><br><span class="line">    <span class="comment">// 解析完成后需要删除 &lt;selectKey&gt; 元素，不参与sqlSource解析</span></span><br><span class="line">    <span class="comment">// Parse selectKey after includes and remove them.</span></span><br><span class="line">    processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span></span><br><span class="line">    KeyGenerator keyGenerator;</span><br><span class="line">    <span class="type">String</span> <span class="variable">keyStatementId</span> <span class="operator">=</span> id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">        keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keyGenerator = context.getBooleanAttribute(<span class="string">&quot;useGeneratedKeys&quot;</span>,</span><br><span class="line">                                                   configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">            ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重要！, 用于解析预处理sql, 参数。这里不会验证sql是否写对了。 </span></span><br><span class="line">    <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">    <span class="comment">// 类型，直接sql、预处理、存储过程</span></span><br><span class="line">    <span class="type">StatementType</span> <span class="variable">statementType</span> <span class="operator">=</span> StatementType.valueOf(context.getStringAttribute(<span class="string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">fetchSize</span> <span class="operator">=</span> context.getIntAttribute(<span class="string">&quot;fetchSize&quot;</span>);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">timeout</span> <span class="operator">=</span> context.getIntAttribute(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">    <span class="comment">// 马上弃用了</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">parameterMap</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;parameterMap&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultType&quot;</span>);</span><br><span class="line">    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultMap</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultMap&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultSetType</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultSetType&quot;</span>);</span><br><span class="line">    <span class="type">ResultSetType</span> <span class="variable">resultSetTypeEnum</span> <span class="operator">=</span> resolveResultSetType(resultSetType);</span><br><span class="line">    <span class="keyword">if</span> (resultSetTypeEnum == <span class="literal">null</span>) &#123;</span><br><span class="line">        resultSetTypeEnum = configuration.getDefaultResultSetType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">keyProperty</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;keyProperty&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">keyColumn</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;keyColumn&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">resultSets</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;resultSets&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用助手，构建MappedStatement，添加到configuration中。</span></span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">                                        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">                                        resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">                                        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只需要注意一下cache</span></span><br><span class="line"><span class="keyword">public</span> MappedStatement <span class="title function_">addMappedStatement</span><span class="params">(</span></span><br><span class="line"><span class="params">    String id,</span></span><br><span class="line"><span class="params">    SqlSource sqlSource,</span></span><br><span class="line"><span class="params">    StatementType statementType,</span></span><br><span class="line"><span class="params">    SqlCommandType sqlCommandType,</span></span><br><span class="line"><span class="params">    Integer fetchSize,</span></span><br><span class="line"><span class="params">    Integer timeout,</span></span><br><span class="line"><span class="params">    String parameterMap,</span></span><br><span class="line"><span class="params">    Class&lt;?&gt; parameterType,</span></span><br><span class="line"><span class="params">    String resultMap,</span></span><br><span class="line"><span class="params">    Class&lt;?&gt; resultType,</span></span><br><span class="line"><span class="params">    ResultSetType resultSetType,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> flushCache,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> useCache,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> resultOrdered,</span></span><br><span class="line"><span class="params">    KeyGenerator keyGenerator,</span></span><br><span class="line"><span class="params">    String keyProperty,</span></span><br><span class="line"><span class="params">    String keyColumn,</span></span><br><span class="line"><span class="params">    String databaseId,</span></span><br><span class="line"><span class="params">    LanguageDriver lang,</span></span><br><span class="line"><span class="params">    String resultSets)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unresolvedCacheRef) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteElementException</span>(<span class="string">&quot;Cache-ref not yet resolved&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id = applyCurrentNamespace(id, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSelect</span> <span class="operator">=</span> sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line"></span><br><span class="line">    MappedStatement.<span class="type">Builder</span> <span class="variable">statementBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappedStatement</span>.Builder(configuration, id, sqlSource, sqlCommandType)</span><br><span class="line">        .resource(resource)</span><br><span class="line">        .fetchSize(fetchSize)</span><br><span class="line">        .timeout(timeout)</span><br><span class="line">        .statementType(statementType)</span><br><span class="line">        .keyGenerator(keyGenerator)</span><br><span class="line">        .keyProperty(keyProperty)</span><br><span class="line">        .keyColumn(keyColumn)</span><br><span class="line">        .databaseId(databaseId)</span><br><span class="line">        .lang(lang)</span><br><span class="line">        .resultOrdered(resultOrdered)</span><br><span class="line">        .resultSets(resultSets)</span><br><span class="line">        .resultMaps(getStatementResultMaps(resultMap, resultType, id))</span><br><span class="line">        .resultSetType(resultSetType)</span><br><span class="line">        .flushCacheRequired(valueOrDefault(flushCache, !isSelect))</span><br><span class="line">        .useCache(valueOrDefault(useCache, isSelect))</span><br><span class="line">        <span class="comment">// 这个currentCache就是当前namespace的缓存，上文提到过</span></span><br><span class="line">        <span class="comment">// currentCache是整个namespace里的所有statement共享</span></span><br><span class="line">        .cache(currentCache);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 弃用了，会在后续的版本中删除</span></span><br><span class="line">    <span class="type">ParameterMap</span> <span class="variable">statementParameterMap</span> <span class="operator">=</span> getStatementParameterMap(parameterMap, parameterType, id);</span><br><span class="line">    <span class="keyword">if</span> (statementParameterMap != <span class="literal">null</span>) &#123;</span><br><span class="line">        statementBuilder.parameterMap(statementParameterMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">MappedStatement</span> <span class="variable">statement</span> <span class="operator">=</span> statementBuilder.build();</span><br><span class="line">    configuration.addMappedStatement(statement);</span><br><span class="line">    <span class="keyword">return</span> statement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>照着官网走了一遍解析配置的流程，总体下来写的不是很满意，太粗糙了。<br>但是大部分常用的功能还是研究了，resultMap交叉解析这一块花了大功夫研究，遇到了很多问题，还碰见了Mybatis的BUG。<br>语言表达能力、写作能力有待训练，下面着重研究缓存和结果集解析功能。<br>后续可能会修改</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/29/%E8%80%81%E9%A1%B9%E7%9B%AE%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B%E6%94%B9%E9%80%A0%20/" rel="prev" title="老项目发布流程改造">
      <i class="fa fa-chevron-left"></i> 老项目发布流程改造
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/16/%E4%B8%AD%E7%BC%80%E4%B8%8E%E5%90%8E%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AE%A1%E7%AE%97/" rel="next" title="中缀与后缀表达式计算.md">
      中缀与后缀表达式计算.md <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="nav-text">一、加载配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E8%A7%A3%E6%9E%90Config"><span class="nav-text">二、解析Config</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-XMLConfigBuilder"><span class="nav-text">1. XMLConfigBuilder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%B1%9E%E6%80%A7%EF%BC%88properties%EF%BC%89"><span class="nav-text">2. 属性（properties）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%AE%BE%E7%BD%AE%EF%BC%88settings%EF%BC%89"><span class="nav-text">3. 设置（settings）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%B1%BB%E5%9E%8B%E5%88%AB%E5%90%8D%EF%BC%88typeAliases%EF%BC%89"><span class="nav-text">4. 类型别名（typeAliases）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E7%B1%BB%E5%9E%8B%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%88typeHandlers%EF%BC%89"><span class="nav-text">5. 类型处理器（typeHandlers）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%AF%B9%E8%B1%A1%E5%B7%A5%E5%8E%82%EF%BC%88objectFactory%EF%BC%89"><span class="nav-text">6. 对象工厂（objectFactory）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%8F%92%E4%BB%B6%EF%BC%88plugins%EF%BC%89"><span class="nav-text">7. 插件（plugins）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-environments%EF%BC%88%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%89"><span class="nav-text">8. environments（环境配置）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-databaseIdProvider%EF%BC%88%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%82%E5%95%86%E6%A0%87%E8%AF%86%EF%BC%89"><span class="nav-text">9. databaseIdProvider（数据库厂商标识）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-mappers%EF%BC%88%E6%98%A0%E5%B0%84%E5%99%A8%EF%BC%89"><span class="nav-text">10. mappers（映射器）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-autoMapping%EF%BC%88%E8%87%AA%E5%8A%A8%E6%98%A0%E5%B0%84%EF%BC%89"><span class="nav-text">11. autoMapping（自动映射）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E8%A7%A3%E6%9E%90Mapper"><span class="nav-text">三、解析Mapper</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-XMLMapperBuilder"><span class="nav-text">1. XMLMapperBuilder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-cache%EF%BC%88%E7%BC%93%E5%AD%98%EF%BC%89"><span class="nav-text">2. cache（缓存）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-cache-ref%EF%BC%88%E7%BC%93%E5%AD%98%E5%BC%95%E7%94%A8%EF%BC%89"><span class="nav-text">3. cache-ref（缓存引用）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-resultMap%EF%BC%88%E7%BB%93%E6%9E%9C%E6%98%A0%E5%B0%84%EF%BC%89"><span class="nav-text">4. resultMap（结果映射）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%94%AF%E6%8C%81%E5%8A%9F%E8%83%BD"><span class="nav-text">1. 支持功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-constructor"><span class="nav-text">1.  constructor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-association"><span class="nav-text">2. association</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-collection"><span class="nav-text">3. collection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-discriminator"><span class="nav-text">4.discriminator</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%8A%9F%E8%83%BD%E8%A7%A3%E6%9E%90"><span class="nav-text">2.功能解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%A7%A3%E6%9E%90resultMap"><span class="nav-text">1. 解析resultMap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%A4%84%E7%90%86constructor"><span class="nav-text">2. 处理constructor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%A4%84%E7%90%86-x2F-%E6%9E%84%E5%BB%BA%E9%89%B4%E5%88%AB%E5%99%A8"><span class="nav-text">3. 处理 &#x2F; 构建鉴别器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%A4%84%E7%90%86-id-x2F-result-x2F-collection"><span class="nav-text">4. 处理 id &#x2F; result &#x2F; collection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E6%9E%84%E5%BB%BAResultMapping"><span class="nav-text">5. 构建ResultMapping</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%8F%91%E7%8E%B0%E9%97%AE%E9%A2%98"><span class="nav-text">3. 发现问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-sql"><span class="nav-text">5. sql</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E8%A7%A3%E6%9E%90Statement"><span class="nav-text">四、解析Statement</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%A7%A3%E6%9E%90CRUD%E5%85%83%E7%B4%A0"><span class="nav-text">1. 解析CRUD元素</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%A7%A3%E6%9E%90Statement%E8%8A%82%E7%82%B9"><span class="nav-text">2. 解析Statement节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">五、总结</span></a></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">JiHongYuan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JiHongYuan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
